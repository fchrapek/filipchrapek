---
// Heavy inspiration taken from Astro Starlight -> https://github.com/withastro/starlight/blob/main/packages/starlight/components/Search.astro
import "@pagefind/default-ui/css/ui.css";
import { siteConfig } from "@/site.config";
import { getLang } from "@/utils/i18n";

const lang = getLang(siteConfig.lang);
const labels = {
  en: {
    open: "Open Search",
    close: "Close",
    devMessage:
      "Search is only available in production builds. Try building and previewing the site to test it out locally.",
  },
  pl: {
    open: "Otwórz wyszukiwanie",
    close: "Zamknij",
    devMessage:
      "Wyszukiwanie dostępne tylko w wersji produkcyjnej. Zbuduj i uruchom podgląd, aby przetestować lokalnie.",
  },
};
---

<site-search class="search" id="search">
  <button
    class="button"
    aria-keyshortcuts="Control+K Meta+K"
    data-open-modal
    disabled
  >
    <svg
      aria-hidden="true"
      class="icon"
      fill="none"
      height="16"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="1.5"
      viewBox="0 0 24 24"
      width="16"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path d="M0 0h24v24H0z" stroke="none"></path>
      <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path>
    </svg>
    <span class="sr-only">{labels[lang].open}</span>
  </button>
  <dialog aria-label="search" class="dialog">
    <div class="dialog-frame">
      <button class="close-button" data-close-modal>{labels[lang].close}</button
      >
      {
        import.meta.env.DEV ? (
          <div class="dev-message">
            <p>{labels[lang].devMessage}</p>
          </div>
        ) : (
          <div class="search-container">
            <div id="cactus__search" />
          </div>
        )
      }
    </div>
  </dialog>
</site-search>

<script>
  class SiteSearch extends HTMLElement {
    #closeBtn: HTMLButtonElement | null;
    #dialog: HTMLDialogElement | null;
    #dialogFrame: HTMLDivElement | null;
    #openBtn: HTMLButtonElement | null;
    #controller: AbortController;

    constructor() {
      super();
      this.#openBtn = this.querySelector<HTMLButtonElement>(
        "button[data-open-modal]",
      );
      this.#closeBtn = this.querySelector<HTMLButtonElement>(
        "button[data-close-modal]",
      );
      this.#dialog = this.querySelector<HTMLDialogElement>("dialog");
      this.#dialogFrame = this.querySelector(".dialog-frame");
      this.#controller = new AbortController();

      // Set up events
      if (this.#openBtn) {
        this.#openBtn.addEventListener("click", this.openModal);
        this.#openBtn.disabled = false;
      } else {
        console.warn("Search button not found");
      }

      if (this.#closeBtn) {
        this.#closeBtn.addEventListener("click", this.closeModal);
      } else {
        console.warn("Close button not found");
      }

      if (this.#dialog) {
        this.#dialog.addEventListener("close", () => {
          window.removeEventListener("click", this.onWindowClick);
        });
      } else {
        console.warn("Dialog not found");
      }

      // only add pagefind in production
      if (import.meta.env.DEV) return;
      const onIdle = window.requestIdleCallback || ((cb) => setTimeout(cb, 1));
      onIdle(async () => {
        const { PagefindUI } = await import("@pagefind/default-ui");
        new PagefindUI({
          baseUrl: import.meta.env.BASE_URL,
          bundlePath:
            import.meta.env.BASE_URL.replace(/\/$/, "") + "/pagefind/",
          element: "#cactus__search",
          showImages: false,
          showSubResults: true,
        });
      });
    }

    connectedCallback() {
      // window events, requires cleanup
      window.addEventListener("keydown", this.onWindowKeydown, {
        signal: this.#controller.signal,
      });
    }

    disconnectedCallback() {
      this.#controller.abort();
    }

    openModal = (event?: MouseEvent) => {
      if (!this.#dialog) {
        console.warn("Dialog not found");
        return;
      }

      this.#dialog.showModal();
      this.querySelector("input")?.focus();
      event?.stopPropagation();
      window.addEventListener("click", this.onWindowClick, {
        signal: this.#controller.signal,
      });
    };

    closeModal = () => this.#dialog?.close();

    onWindowClick = (event: MouseEvent) => {
      // check if it's a link
      const isLink = "href" in (event.target || {});
      // make sure the click is either a link or outside of the dialog
      if (
        isLink ||
        (document.body.contains(event.target as Node) &&
          !this.#dialogFrame?.contains(event.target as Node))
      ) {
        this.closeModal();
      }
    };

    onWindowKeydown = (e: KeyboardEvent) => {
      if (!this.#dialog) {
        console.warn("Dialog not found");
        return;
      }
      // check if it's the Control+K or ⌘+K shortcut
      if ((e.metaKey === true || e.ctrlKey === true) && e.key === "k") {
        this.#dialog.open ? this.closeModal() : this.openModal();
        e.preventDefault();
      }
    };
  }

  customElements.define("site-search", SiteSearch);
</script>

<style>
  .search {
    margin-inline-start: auto;
  }

  .button {
    display: flex;
    justify-content: center;
    align-items: center;
    inline-size: 2.25rem;
    block-size: 2.25rem;
    padding: 0;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    color: var(--color-text);
    transition: color 0.2s ease;

    &:hover {
      color: var(--color-accent);
    }
  }

  .icon {
    inline-size: 1.75rem;
    block-size: 1.75rem;
  }

  .dialog {
    inline-size: 100%;
    max-inline-size: 100%;
    block-size: 100%;
    max-block-size: 100%;
    border: 1px solid var(--color-zinc-400);
    background-color: var(--color-bg);
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);

    &::backdrop {
      backdrop-filter: blur(4px);
    }

    &[open] {
      display: flex;
    }

    @media (min-width: 40rem) {
      inline-size: 83.333333%;
      max-inline-size: 48rem;
      block-size: max-content;
      min-block-size: 15rem;
      max-block-size: calc(100% - 8rem);
      margin: 4rem auto auto;
      border-radius: 0.375rem;
    }
  }

  .dialog-frame {
    display: flex;
    flex-grow: 1;
    flex-direction: column;
    gap: var(--space-sm);
    padding: var(--space-md);
    padding-block-start: var(--space-sm);

    @media (min-width: 40rem) {
      padding-block-start: var(--space-md);
    }
  }

  .close-button {
    margin-inline-start: auto;
    padding: var(--space-xs);
    border: none;
    border-radius: 0.375rem;
    background-color: var(--color-zinc-200);
    font-weight: var(--font-medium);
    cursor: pointer;

    :global(html[data-theme="dark"]) & {
      background-color: var(--color-zinc-700);
    }
  }

  .dev-message {
    margin-inline: auto;
    text-align: center;
  }

  /* Pagefind customization */
  :global(#cactus__search) {
    --pagefind-ui-primary: var(--color-accent);
    --pagefind-ui-text: var(--color-text);
    --pagefind-ui-background: var(--color-zinc-100);
    --pagefind-ui-border: var(--color-zinc-300);
    --pagefind-ui-border-width: 1px;
  }

  :global(html[data-theme="dark"]) :global(#cactus__search) {
    --pagefind-ui-background: var(--color-zinc-800);
    --pagefind-ui-border: var(--color-zinc-500);
  }

  :global(#cactus__search .pagefind-ui__search-clear) {
    inline-size: calc(60px * var(--pagefind-ui-scale));
    padding: 0;
    overflow: hidden;
    background-color: transparent;

    &:focus {
      outline: 1px solid var(--color-accent-2);
    }

    &::before {
      content: "";
      display: block;
      inline-size: 100%;
      block-size: 100%;
      background-color: var(--color-accent);
      -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor' %3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'%3E%3C/path%3E%3C/svg%3E")
        center / 60% no-repeat;
      mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='currentColor' %3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M6 18L18 6M6 6l12 12'%3E%3C/path%3E%3C/svg%3E")
        center / 60% no-repeat;
    }
  }

  :global(#cactus__search .pagefind-ui__result) {
    border: 0;
  }

  :global(#cactus__search .pagefind-ui__result-link) {
    background-image: linear-gradient(
      transparent,
      transparent 5px,
      var(--color-text) 5px,
      var(--color-text)
    );
    background-repeat: repeat-x;
    background-position: bottom;
    background-size: 100% 6px;

    &:hover {
      background-image: linear-gradient(
        transparent,
        transparent 4px,
        var(--color-link) 4px,
        var(--color-link)
      );
      text-decoration: none;
    }
  }

  :global(#cactus__search mark) {
    background-color: transparent;
    color: var(--color-quote);
    font-weight: var(--font-medium);
  }
</style>
